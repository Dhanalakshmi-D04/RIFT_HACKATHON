name: 'Self-Hosted: Release, Build and Publish'

on:
    workflow_dispatch:
        inputs:
            version_type:
                description: 'Release type (semver)'
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major
                    - custom
            custom_version:
                description: 'Custom version (e.g. 2.1.0) - required if type is custom'
                required: false

jobs:
    create-release:
        name: Create Release and Tag
        runs-on: ubuntu-latest
        outputs:
            new_version: ${{ steps.bump.outputs.new_version }}
        permissions:
            contents: write
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4.2.2
              with:
                  fetch-depth: 0

            - name: Get Latest Release
              id: get_latest
              run: |
                  set -euo pipefail
                  # Get latest tag that looks like a version (ignore web-*, etc)
                  LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | awk '!/web-/{print; exit}')
                  if [ -z "${LATEST_TAG}" ]; then
                    LATEST_TAG="v0.0.0"
                  fi
                  echo "Latest version: $LATEST_TAG"
                  echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

            - name: Bump Version
              id: bump
              run: |
                  set -euo pipefail
                  LATEST="${{ steps.get_latest.outputs.latest_tag }}"
                  if [[ ! "$LATEST" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "Invalid latest tag format: $LATEST (expected vMAJOR.MINOR.PATCH)"
                    exit 1
                  fi

                  # Remove 'v' prefix for calculation
                  VERSION=${LATEST#v}

                  IFS='.' read -r -a parts <<< "$VERSION"
                  MAJOR=${parts[0]}
                  MINOR=${parts[1]}
                  PATCH=${parts[2]}

                  TYPE="${{ github.event.inputs.version_type }}"

                  if [ "$TYPE" == "custom" ]; then
                    NEW_VERSION="${{ github.event.inputs.custom_version }}"
                    # Ensure it has v prefix if missing
                    if [[ "$NEW_VERSION" != v* ]]; then
                        NEW_VERSION="v$NEW_VERSION"
                    fi
                    if [[ ! "$NEW_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                      echo "Invalid custom version: $NEW_VERSION (expected vMAJOR.MINOR.PATCH)"
                      exit 1
                    fi
                  elif [ "$TYPE" == "major" ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                    NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
                  elif [ "$TYPE" == "minor" ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                    NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
                  else
                    PATCH=$((PATCH + 1))
                    NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
                  fi

                  echo "New version: $NEW_VERSION"
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

            - name: Create Git Tag
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git tag ${{ steps.bump.outputs.new_version }}
                  git push origin ${{ steps.bump.outputs.new_version }}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2.0.4
              with:
                  tag_name: ${{ steps.bump.outputs.new_version }}
                  name: 'Self-Hosted Release ${{ steps.bump.outputs.new_version }}'
                  generate_release_notes: true
                  prerelease: false

    build-and-push:
        name: Build and Push Docker Images
        needs: create-release
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4.2.2
              with:
                  ref: ${{ needs.create-release.outputs.new_version }}

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3.2.0
              with:
                  platforms: amd64,arm64

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3.10.0

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3.4.0
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and Push Docker Images
              env:
                  TAG: ${{ needs.create-release.outputs.new_version }}
                  API_TAGS: ghcr.io/${{ github.repository_owner }}/kodus-ai-api:${{ needs.create-release.outputs.new_version }},ghcr.io/${{ github.repository_owner }}/kodus-ai-api:latest
                  WEBHOOKS_TAGS: ghcr.io/${{ github.repository_owner }}/kodus-ai-webhook:${{ needs.create-release.outputs.new_version }},ghcr.io/${{ github.repository_owner }}/kodus-ai-webhook:latest
                  WORKER_TAGS: ghcr.io/${{ github.repository_owner }}/kodus-ai-worker:${{ needs.create-release.outputs.new_version }},ghcr.io/${{ github.repository_owner }}/kodus-ai-worker:latest
                  WEB_TAGS: ghcr.io/${{ github.repository_owner }}/kodus-ai-web:${{ needs.create-release.outputs.new_version }},ghcr.io/${{ github.repository_owner }}/kodus-ai-web:latest
              run: |
                  set -euo pipefail

                  docker buildx bake -f docker-bake.hcl \
                    --set base.args.RELEASE_VERSION=${TAG} \
                    --set base.args.API_CLOUD_MODE=false \
                    --set base.cache-from=type=gha \
                    --set base.cache-to=type=gha,mode=max \
                    --set *.platform=linux/amd64,linux/arm64 \
                    --push

            - name: Notify Discord on Success
              if: success()
              uses: sarisia/actions-status-discord@v1.15.3
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK }}
                  content: ':tada: New Release `${{ needs.create-release.outputs.new_version }}` published!'
                  title: 'Self-Hosted Release'
                  description: 'Docker images built and pushed to GHCR. Tag created on GitHub.'
                  username: 'GitHub Actions'
                  color: 0x00FF00

            - name: Notify Discord on Failure
              if: failure()
              uses: sarisia/actions-status-discord@v1.15.3
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK }}
                  content: ':x: Failed to publish release `${{ needs.create-release.outputs.new_version }}`.'
                  title: 'Self-Hosted Release Failed'
                  username: 'GitHub Actions'
                  color: 0xFF0000
