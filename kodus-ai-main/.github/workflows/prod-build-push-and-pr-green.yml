name: "Backend: Production GitOps Deploy"

# Release routing:
# - backend: semantic tags like 1.2.3
# - web: tags prefixed with web- (handled by Web workflows)
# - selfhosted: separate workflow that builds all services together

on:
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            image_tag:
                description: "ECR image tag (default: release tag)"
                required: false

concurrency:
    group: prod-gitops-deploy
    cancel-in-progress: false

permissions:
    contents: read

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    IMAGE_TAG: ${{ github.event.inputs.image_tag || github.event.release.tag_name || github.sha }}
    BUILDX_PLATFORMS: linux/arm64
    BUILDX_CACHE_SCOPE: kodus-ai-arm64

    # ECR repositories (required)
    ECR_REPOSITORY_API: ${{ vars.ECR_REPOSITORY_API }}
    ECR_REPOSITORY_WEBHOOKS: ${{ vars.ECR_REPOSITORY_WEBHOOKS }}
    ECR_REPOSITORY_WORKER: ${{ vars.ECR_REPOSITORY_WORKER }}

    # GitOps (required)
    INFRA_REPO: ${{ vars.INFRA_REPO }}
    INFRA_BASE_BRANCH: ${{ vars.INFRA_BASE_BRANCH }}
    INFRA_TFVARS_PATH: ${{ vars.INFRA_TFVARS_PATH }}

jobs:
    build_push_and_deploy:
        name: Build/push backend images and open deploy PR
        runs-on: ubuntu-latest
        environment: production
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'release' && !startsWith(github.event.release.tag_name, 'web-')) ||
            (startsWith(github.ref, 'refs/tags/') && !startsWith(github.ref_name, 'web-'))
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Validate tag format (x.y.z)
              if: github.event_name != 'workflow_dispatch'
              run: |
                  set -euo pipefail
                  TAG="${{ env.IMAGE_TAG }}"
                  if ! echo "$TAG" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                    echo "Invalid PROD tag format (expected x.y.z): $TAG"
                    exit 1
                  fi

            - name: Validate required secrets
              run: |
                  set -euo pipefail
                  if [ -z "${{ vars.INFRA_GITHUB_APP_ID }}" ]; then
                    echo "Missing variable: INFRA_GITHUB_APP_ID"
                    exit 1
                  fi
                  for v in ECR_REPOSITORY_API ECR_REPOSITORY_WEBHOOKS ECR_REPOSITORY_WORKER INFRA_REPO INFRA_BASE_BRANCH INFRA_TFVARS_PATH; do
                    if [ -z "${!v:-}" ]; then
                      echo "Missing required variable: $v"
                      exit 1
                    fi
                  done
                  if [ -z "${{ secrets.INFRA_GITHUB_APP_PRIVATE_KEY }}" ]; then
                    echo "Missing secret: INFRA_GITHUB_APP_PRIVATE_KEY"
                    exit 1
                  fi
                  if [ -z "${{ secrets.AWS_REGION }}" ]; then
                    echo "Missing secret: AWS_REGION"
                    exit 1
                  fi
                  if [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then
                    echo "Missing secret: AWS_ROLE_TO_ASSUME (OIDC is required for PROD)"
                    exit 1
                  fi

            - name: Parse infra repo
              run: |
                  set -euo pipefail
                  repo="${{ env.INFRA_REPO }}"
                  if [[ "$repo" == */* ]]; then
                    owner="${repo%%/*}"
                    name="${repo#*/}"
                  else
                    owner="${{ github.repository_owner }}"
                    name="$repo"
                  fi
                  echo "INFRA_REPO_OWNER=$owner" >> "$GITHUB_ENV"
                  echo "INFRA_REPO_NAME=$name" >> "$GITHUB_ENV"

            - name: Get infra repo token (GitHub App)
              id: infra_token
              uses: actions/create-github-app-token@v1.11.0
              with:
                  app-id: ${{ vars.INFRA_GITHUB_APP_ID }}
                  private-key: ${{ secrets.INFRA_GITHUB_APP_PRIVATE_KEY }}
                  owner: ${{ env.INFRA_REPO_OWNER }}
                  repositories: ${{ env.INFRA_REPO_NAME }}

            - name: Debug infra token
              run: |
                  curl -sS -H "Authorization: token ${{ steps.infra_token.outputs.token }}" \
                    https://api.github.com/repos/kodustech/kodus-infra | jq '{full_name, permissions}'

            - name: Checkout code
              uses: actions/checkout@v4.2.2

            - name: Configure AWS Credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4.1.0
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2.0.1

            - name: Mask ECR registry
              run: echo "::add-mask::${{ steps.login-ecr.outputs.registry }}"

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3.2.0
              with:
                  platforms: arm64

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3.10.0

            - name: Build, tag, and push (api/webhooks/worker)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  API_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}
                  WEBHOOKS_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}
                  WORKER_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}
              run: |
                  set -euo pipefail

                  docker buildx bake -f docker-bake.hcl \
                    --set base.args.RELEASE_VERSION=${{ env.IMAGE_TAG }} \
                    --set base.args.API_CLOUD_MODE=true \
                    --set base.cache-from=type=gha,scope=${{ env.BUILDX_CACHE_SCOPE }} \
                    --set base.cache-to=type=gha,scope=${{ env.BUILDX_CACHE_SCOPE }},mode=max \
                    --set *.platform=${{ env.BUILDX_PLATFORMS }} \
                    --push \
                    api webhooks worker

            - name: Checkout infra repo
              uses: actions/checkout@v4.2.2
              with:
                  repository: ${{ env.INFRA_REPO }}
                  ref: ${{ env.INFRA_BASE_BRANCH }}
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra

            - name: Update tfvars (Deploy new images)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
              run: |
                  set -euo pipefail

                  FILE="infra/${{ env.INFRA_TFVARS_PATH }}"
                  API_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}"
                  WEBHOOKS_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}"
                  WORKER_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}"

                  ./scripts/gitops/update-tfvars-deploy.sh \
                    "$FILE" \
                    "$API_IMAGE" \
                    "$WEBHOOKS_IMAGE" \
                    "$WORKER_IMAGE"

                  echo "âœ… Updated $FILE"

            - name: Verify infra changes scope
              run: |
                  set -euo pipefail
                  cd infra
                  changed="$(git diff --name-only)"
                  if [ "$(echo "$changed" | wc -l | tr -d ' ')" -ne 1 ]; then
                    echo "Expected exactly 1 changed file in infra repo."
                    exit 1
                  fi
                  if [ "$changed" != "${{ env.INFRA_TFVARS_PATH }}" ]; then
                    echo "Unexpected changed file: $changed"
                    exit 1
                  fi

            - name: Create PR (Deploy)
              id: create_pr
              uses: peter-evans/create-pull-request@v7
              with:
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra
                  branch: deploy/prod-${{ env.IMAGE_TAG }}
                  base: ${{ env.INFRA_BASE_BRANCH }}
                  title: "PROD Deploy: New version ${{ env.IMAGE_TAG }}"
                  commit-message: "prod: deploy v${{ env.IMAGE_TAG }}"
                  body: |
                      ## ðŸš€ PROD Deployment (ECS Blue/Green nativo)
                      Updating images to `${{ env.IMAGE_TAG }}`.

                      ## ðŸ›  Atlantis Commands
                      ```bash
                      atlantis plan -p aws-prod-app-services-ecs-ec2
                      ```
                      ```bash
                      atlantis apply -p aws-prod-app-services-ecs-ec2
                      ```

                      âœ… O ECS faz o shift automaticamente apos health checks.

                      ## ðŸ”™ Rollback
                      Reverter este PR e aplicar via Atlantis.

                      ---
                      *Triggered by: @${{ github.actor }}*

            - name: Notify Discord (Deploy PR Created)
              if: success() && steps.create_pr.outputs.pull-request-number
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  if [ -n "$DISCORD_WEBHOOK" ]; then
                    curl -H "Content-Type: application/json" -X POST "$DISCORD_WEBHOOK" -d '{
                      "embeds": [{
                        "title": "ðŸš€ PROD: New Deploy Ready",
                        "description": "New version **v${{ env.IMAGE_TAG }}** ready for ECS Blue/Green",
                        "color": 5763719,
                        "fields": [
                          {"name": "Version", "value": "`${{ env.IMAGE_TAG }}`", "inline": true},
                          {"name": "Triggered by", "value": "@${{ github.actor }}", "inline": true},
                          {"name": "PR", "value": "[#${{ steps.create_pr.outputs.pull-request-number }}](${{ steps.create_pr.outputs.pull-request-url }})", "inline": false},
                          {"name": "Next Steps", "value": "1. Review and apply PR via Atlantis\n2. Validate health\n3. ECS will shift traffic automatically", "inline": false}
                        ],
                        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                      }]
                    }'
                  fi

            - name: Notify Discord (Deploy Failed)
              if: failure()
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  if [ -n "$DISCORD_WEBHOOK" ]; then
                    curl -H "Content-Type: application/json" -X POST "$DISCORD_WEBHOOK" -d '{
                      "embeds": [{
                        "title": "âŒ PROD: Deploy Failed",
                        "description": "Failed to deploy v${{ env.IMAGE_TAG }}",
                        "color": 15158332,
                        "fields": [
                          {"name": "Version", "value": "`${{ env.IMAGE_TAG }}`", "inline": true},
                          {"name": "Triggered by", "value": "@${{ github.actor }}", "inline": true},
                          {"name": "Action Required", "value": "Check workflow logs:\n[View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                        ],
                        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                      }]
                    }'
                  fi

    changelog:
        needs: build_push_and_deploy
        runs-on: ubuntu-latest
        if: github.event_name == 'release'
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4.2.2

            - name: Get previous release date
              id: prev
              run: |
                  prev=$(gh release list -R ${{ github.repository }} --limit 2 \
                    --json tagName,publishedAt -q '.[1].publishedAt // empty')
                  echo "date=${prev:-$(date -d '-30 days' -Idate)}" >> "$GITHUB_OUTPUT"
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate changelog
              run: |
                  end_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                  http_code=$(curl -s -o response.json -w "%{http_code}" -X POST "${{ secrets.CHANGELOG_API_URL }}/api/v1/changelog" \
                    -H "Content-Type: application/json" \
                    -d '{
                      "owner": "${{ github.repository_owner }}",
                      "repo": "${{ github.event.repository.name }}",
                      "startDate": "${{ steps.prev.outputs.date }}",
                      "endDate": "'"$end_date"'",
                      "style": "Write for end-users â€” no technical details, keep it clear and meaningful. Group related changes into a single item when they are part of the same improvement. Categorize into: New Features, Improvements, Bug Fixes, Chore / DevEx. Only include a category if it has items. Only include changes that were actually released.",
                      "webhookUrl": "${{ secrets.WEBHOOK_URL }}",
                      "version": "${{ github.event.release.tag_name }}"
                    }')
                  if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
                    echo "Changelog API returned HTTP $http_code"
                    cat response.json
                    exit 1
                  fi
                  jq -r '.changelog' response.json > changelog.md
                  if [ ! -s changelog.md ]; then
                    echo "Error: changelog.md is empty â€” refusing to overwrite release notes"
                    exit 1
                  fi
                  echo "Generated changelog for ${{ github.event.release.tag_name }}"

            - name: Update release notes
              run: |
                  gh release edit ${{ github.event.release.tag_name }} \
                    -R ${{ github.repository }} \
                    --notes-file changelog.md
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
