x-app-service-template: &app-service-defaults
    build:
        context: .
        dockerfile: docker/Dockerfile.dev
        args:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
    env_file:
        - ${ENV_FILE:-.env}
    environment:
        - CHOKIDAR_USEPOLLING=false
        - API_DEVELOPMENT_MODE=${API_DEVELOPMENT_MODE:-true}
    restart: unless-stopped
    volumes:
        - .:/usr/src/app:delegated
        - node_modules_cache:/usr/src/app/node_modules
        - yalc_store:/root/.yalc
    networks:
        - kodus-backend-services
        - shared-network

services:
    #----------------------------------------------------------------
    # Application Services
    #----------------------------------------------------------------
    kodus-api:
        <<: *app-service-defaults
        container_name: kodus_api
        ports:
            - '${API_PORT:-3001}:${API_PORT:-3001}'
            - '9229:9229'
            - '8000:8000'
        command: yarn start:dev:api
        deploy:
            resources:
                limits:
                    memory: 1.5G
                reservations:
                    memory: 512M
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    "node -e \"const http=require('http'); const port=process.env.API_PORT||3001; const req=http.get({host:'127.0.0.1', port, path:'/health', timeout:2000}, (res)=>process.exit(res.statusCode===200?0:1)); req.on('error', ()=>process.exit(1)); req.on('timeout', ()=>{ req.destroy(); process.exit(1); });\"",
                ]
            interval: 20s
            timeout: 10s
            retries: 8
            start_period: 180s
        environment:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
            - NODE_OPTIONS=--max-old-space-size=1200 --max-semi-space-size=64
            - DEBUG_PORT=9229
            - API_LOG_PRETTY=true
            - CHOKIDAR_USEPOLLING=false
            - API_DEVELOPMENT_MODE=${API_DEVELOPMENT_MODE:-true}
            - RUN_MIGRATIONS=true
            - RUN_SEEDS=true
            - PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_ADDRESS:-http://pyroscope:4040}
            - PYROSCOPE_HEAP_PROFILING=${PYROSCOPE_HEAP_PROFILING:-true}

    worker:
        <<: *app-service-defaults
        container_name: kodus_worker
        ports:
            - '9231:9231'
            - '8001:8001'
        command: yarn start:dev:worker
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 512M
        healthcheck:
            test: ['CMD', 'node', '-e', 'process.exit(0)']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        environment:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
            - NODE_OPTIONS=--max-semi-space-size=64
            - DEBUG_PORT=9231
            - COMPONENT_TYPE=worker
            - API_LOG_PRETTY=true
            - PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_ADDRESS:-http://pyroscope:4040}
            - PYROSCOPE_HEAP_PROFILING=${PYROSCOPE_HEAP_PROFILING:-true}

    webhooks:
        <<: *app-service-defaults
        container_name: kodus_webhooks
        ports:
            - '${API_WEBHOOKS_PORT:-3332}:${API_WEBHOOKS_PORT:-3332}'
            - '9232:9232'
            - '8002:8002'
        command: yarn start:dev:webhooks
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 256M
        healthcheck:
            test: ['CMD', 'node', '-e', 'process.exit(0)']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        environment:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
            - NODE_OPTIONS=--max-semi-space-size=64
            - DEBUG_PORT=9232
            - API_LOG_PRETTY=true
            - PYROSCOPE_SERVER_ADDRESS=${PYROSCOPE_SERVER_ADDRESS:-http://pyroscope:4040}
            - PYROSCOPE_HEAP_PROFILING=${PYROSCOPE_HEAP_PROFILING:-true}

    #----------------------------------------------------------------
    # Web Frontend
    #----------------------------------------------------------------
    web:
        build:
            context: ./apps/web
            dockerfile: ../../docker/Dockerfile.web.dev
        container_name: kodus_web
        depends_on:
            kodus-api:
                condition: service_healthy
        ports:
            - '${WEB_PORT:-3000}:3000'
        env_file:
            - ${ENV_FILE:-.env}
        volumes:
            - ./apps/web:/usr/src/app:delegated
            - web_node_modules_cache:/usr/src/app/node_modules
            - web_next_cache:/usr/src/app/.next
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:3000']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
        networks:
            - kodus-backend-services
            - shared-network
        environment:
            - CHOKIDAR_USEPOLLING=false
            - NODE_ENV=development
            - NEXT_TELEMETRY_DISABLED=1
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 512M

    #----------------------------------------------------------------
    # Observability & Profiling
    #----------------------------------------------------------------
    pyroscope:
        profiles:
            - profiling
            - infra
        image: docker.io/grafana/pyroscope:latest
        container_name: pyroscope
        ports:
            - '4040:4040'
        volumes:
            - pyroscope-data:/var/lib/pyroscope
        networks:
            - kodus-backend-services
        restart: unless-stopped

    #----------------------------------------------------------------
    # Databases & Infrastructure
    #----------------------------------------------------------------
    rabbitmq:
        profiles:
            - local-db
            - infra
        build:
            context: ./docker/rabbitMQ
            dockerfile: Dockerfile
        container_name: rabbitmq
        hostname: ${RABBITMQ_HOSTNAME:-rabbitmq-local}
        ports:
            - '5672:5672'
            - '15672:15672'
            - '15692:15692'
        volumes:
            - rabbitmq-data:/var/lib/rabbitmq
        restart: unless-stopped
        networks:
            kodus-backend-services:
                aliases:
                    - rabbitmq-local
                    - rabbitmq
            shared-network:
                aliases:
                    - rabbitmq-local
                    - rabbitmq
        healthcheck:
            test: ['CMD', 'rabbitmq-diagnostics', '-q', 'check_running']
            interval: 30s
            timeout: 10s
            retries: 5
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-dev}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-devpass}
            RABBITMQ_HOSTNAME: ${RABBITMQ_HOSTNAME:-rabbitmq}
            RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit heartbeat 60"
        command: /usr/local/bin/init-definitions.sh

    db_postgres:
        profiles:
            - local-db
            - infra
        image: docker.io/pgvector/pgvector:pg16
        container_name: db_postgres
        ports:
            - '5432:5432'
        environment:
            POSTGRES_USER: ${API_PG_DB_USERNAME}
            POSTGRES_PASSWORD: ${API_PG_DB_PASSWORD}
            POSTGRES_DB: ${API_PG_DB_DATABASE}
        volumes:
            - pgdata:/var/lib/postgresql/data
            - ./docker/postgres/initdb.d:/docker-entrypoint-initdb.d
        networks:
            - kodus-backend-services
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U ${API_PG_DB_USERNAME} -d ${API_PG_DB_DATABASE}',
                ]
            interval: 5s
            timeout: 3s
            retries: 20
            start_period: 10s

    db_mongodb:
        profiles:
            - local-db
            - infra
        image: docker.io/mongo:8
        container_name: mongodb
        ports:
            - '27017:27017'
        volumes:
            - mongodbdata:/data/db
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${API_MG_DB_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${API_MG_DB_PASSWORD}
            MONGO_INITDB_DATABASE: ${API_MG_DB_DATABASE}
        networks:
            - kodus-backend-services
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    "echo 'db.runCommand({ ping: 1 }).ok' | mongosh --quiet mongodb://$${MONGO_INITDB_ROOT_USERNAME}:$${MONGO_INITDB_ROOT_PASSWORD}@localhost:27017/admin | grep -q 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 20
            start_period: 20s

volumes:
    yalc_store:
    node_modules_cache:
    web_node_modules_cache:
    web_next_cache:
    pgdata:
    mongodbdata:
    pyroscope-data:
    rabbitmq-data:

networks:
    kodus-backend-services:
        driver: bridge
        name: kodus-backend-services
        external: true
    shared-network:
        external: true
